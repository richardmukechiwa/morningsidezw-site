<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Onboarding - KYC Verification</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* Updated Background Color */
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 520px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        h1 { text-align: center; margin-bottom: 6px; color: #333; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }
        fieldset { border: none; margin-bottom: 24px; padding: 0; }
        legend { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 12px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; color: #444; font-size: 14px; }
        input[type="text"], input[type="tel"], input[type="email"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="tel"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .file-box {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9fafb;
        }
        .file-box:hover { border-color: #667eea; background: #f3f4f6; }
        .file-box.has-file { border-color: #48bb78; background: #f0fff4; border-style: solid; }
        .file-box input { display: none; }
        .file-name { font-size: 12px; margin-top: 6px; color: #2f855a; font-weight: 600; }
        .info-text { color: #666; font-size: 13px; margin: 10px 0; line-height: 1.5; }
        .camera-section { margin-top: 12px; }
        #cameraContainer { margin-top: 12px; }
        .camera-preview {
            width: 100%;
            max-width: 320px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        #video { display: block; }
        #canvas { display: none; }
        #photoPreview { margin-top: 12px; text-align: center; }
        #photoPreview img {
            max-width: 320px;
            border-radius: 8px;
            border: 2px solid #48bb78;
            display: block;
            margin: 0 auto;
        }
        button {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: none;
            /* Updated Button Color */
            background: linear-gradient(135deg, #334155 0%, #0f172a 100%);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, opacity 0.3s;
        }
        button:hover { transform: translateY(-1px); opacity: 0.95; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        button.secondary { background: #edf2f7; color: #333; margin-top: 8px; }
        button.secondary:hover { background: #e2e8f0; }
        .status { font-size: 13px; margin-top: 6px; padding: 8px; border-radius: 6px; text-align: center; }
        .status.ok { background: #d4edda; color: #2f855a; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.uploading { background: #fff3cd; color: #856404; }
        #overallStatus { margin-top: 20px; font-weight: 600; text-align: center; padding: 12px; border-radius: 8px; font-size: 14px; }
        .divider { text-align: center; margin: 15px 0; color: #999; font-size: 13px; font-weight: 600; }
        .progress-bar { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: #48bb78; transition: width 0.3s; width: 0%; }
        .consent-box { background: #f8f9fa; border: 1px solid #cbd5e0; border-radius: 8px; padding: 16px; }
        .consent-label { display: flex; align-items: flex-start; cursor: pointer; font-size: 13px; line-height: 1.6; }
        .consent-label input[type="checkbox"] { margin-top: 4px; margin-right: 12px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
        .consent-text { color: #444; }
        .consent-text ul { margin: 10px 0 0 20px; padding: 0; }
        .consent-text li { margin: 6px 0; color: #666; }
        .privacy-link { margin-top: 12px; font-size: 12px; text-align: center; }
        .privacy-link a { color: #334155; text-decoration: none; font-weight: 600; }
        .privacy-link a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Agent Onboarding</h1>
        <p class="subtitle">Complete KYC verification to get started</p>
        <form id="onboardingForm">
            <fieldset>
                <legend>Personal Information</legend>
                <div class="form-group">
                    <label for="full_name">Full Name</label>
                    <input id="full_name" type="text" name="full_name" autocomplete="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input id="email" type="email" name="email" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <label for="id_number">ID Number</label>
                    <input id="id_number" type="text" name="id_number" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input id="phone" type="tel" name="phone" autocomplete="tel" required>
                </div>
                <div class="form-group">
                    <label for="address">Address</label>
                    <input id="address" type="text" name="address" autocomplete="street-address" required>
                </div>
            </fieldset>

            <fieldset>
                <legend>Required Documents</legend>
                <div class="form-group">
                    <label for="id_front">ID Front (Government-issued)</label>
                    <div class="file-box" id="idFrontBox">
                        <input type="file" id="id_front" accept=".jpg,.jpeg,.png,.pdf" required>
                        <span>üìÑ Upload ID Front</span>
                        <div class="file-name" id="idFrontName"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="id_back">ID Back</label>
                    <div class="file-box" id="idBackBox">
                        <input type="file" id="id_back" accept=".jpg,.jpeg,.png,.pdf" required>
                        <span>üìÑ Upload ID Back</span>
                        <div class="file-name" id="idBackName"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="proof_of_address">Proof of Address</label>
                    <div class="file-box" id="poaBox">
                        <input type="file" id="proof_of_address" accept=".jpg,.jpeg,.png,.pdf" required>
                        <span>üìÑ Upload Proof of Address</span>
                        <div class="file-name" id="poaName"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Data Protection & Consent</legend>
                <div class="consent-box">
                    <label class="consent-label">
                        <input type="checkbox" id="data_consent" name="data_consent" required>
                        <span class="consent-text">
                            I consent to the collection, processing, and storage of my personal data and identity documents for KYC verification purposes. I understand that:
                            <ul>
                                <li>My data will be securely stored and used only for identity verification</li>
                                <li>My documents will be analyzed using AI-powered verification systems</li>
                                <li>I have the right to access, correct, or request deletion of my data</li>
                            </ul>
                        </span>
                    </label>
                    <p class="privacy-link">
                        <a href="/privacy-policy" target="_blank">Read our full Privacy Policy</a>
                    </p>
                </div>
            </fieldset>

            <fieldset>
                <legend>Identity Verification</legend>
                <p class="info-text">Take a clear selfie or upload a recent passport-style photo.</p>
                <div class="camera-section">
                    <button type="button" class="secondary" id="openCamera">üì∑ Take Photo</button>
                    <div id="cameraContainer" style="display:none;">
                        <video id="video" class="camera-preview" autoplay></video>
                        <canvas id="canvas" class="camera-preview"></canvas>
                        <button type="button" id="capturePhoto">Capture</button>
                        <button type="button" class="secondary" id="retakePhoto" style="display:none;">Retake</button>
                    </div>
                </div>
                <div class="divider">OR</div>
                <div class="form-group">
                    <div class="file-box" id="passportBox">
                        <input type="file" id="passport_photo" accept=".jpg,.jpeg,.png">
                        <span>üì∑ Upload Photo</span>
                        <div class="file-name" id="passportName"></div>
                    </div>
                </div>
                <div id="photoPreview"></div>
            </fieldset>

            <button type="submit" id="submitBtn">Submit Application</button>
            <div class="progress-bar" id="progressBar" style="display:none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="overallStatus"></div>
        </form>
    </div>

<script>
const WEBHOOK_URL = 'https://api.morningsidezw.com/submit';
let passportPhotoFile = null;
let stream = null;

const fileBoxes = [
    ['id_front', 'idFrontBox', 'idFrontName'],
    ['id_back', 'idBackBox', 'idBackName'],
    ['proof_of_address', 'poaBox', 'poaName'],
    ['passport_photo', 'passportBox', 'passportName']
];

fileBoxes.forEach(([inputId, boxId, nameId]) => {
    const input = document.getElementById(inputId);
    const box = document.getElementById(boxId);
    const nameEl = document.getElementById(nameId);
    if (!input || !box) return;
    box.addEventListener('click', () => input.click());
    input.addEventListener('change', (e) => {
        if (e.target.files.length) {
            box.classList.add('has-file');
            nameEl.textContent = '‚úì ' + e.target.files[0].name;
        }
    });
});

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const openCameraBtn = document.getElementById('openCamera');
const captureBtn = document.getElementById('capturePhoto');
const retakeBtn = document.getElementById('retakePhoto');
const cameraContainer = document.getElementById('cameraContainer');
const photoPreview = document.getElementById('photoPreview');

openCameraBtn.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } });
        video.srcObject = stream;
        cameraContainer.style.display = 'block';
        openCameraBtn.style.display = 'none';
    } catch (err) { alert('Camera access denied: ' + err.message); }
});

captureBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    canvas.toBlob((blob) => {
        passportPhotoFile = new File([blob], 'passport_photo.jpg', { type: 'image/jpeg' });
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        photoPreview.innerHTML = '';
        photoPreview.appendChild(img);
        video.style.display = 'none';
        canvas.style.display = 'block';
        captureBtn.style.display = 'none';
        retakeBtn.style.display = 'inline-block';
        if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
    }, 'image/jpeg', 0.9);
});

retakeBtn.addEventListener('click', async () => {
    video.style.display = 'block';
    canvas.style.display = 'none';
    captureBtn.style.display = 'inline-block';
    retakeBtn.style.display = 'none';
    photoPreview.innerHTML = '';
    passportPhotoFile = null;
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } });
        video.srcObject = stream;
    } catch (err) { alert('Camera access denied'); }
});

document.getElementById('passport_photo').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        passportPhotoFile = file;
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        photoPreview.innerHTML = '';
        photoPreview.appendChild(img);
        if (stream) { stream.getTracks().forEach(track => track.stop()); cameraContainer.style.display = 'none'; openCameraBtn.style.display = 'inline-block'; }
    }
});

function updateProgress(percent) {
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.style.display = 'block';
    progressFill.style.width = percent + '%';
}

function updateStatus(message, type = 'info') {
    const statusDiv = document.getElementById('overallStatus');
    statusDiv.style.display = 'block';
    statusDiv.textContent = message;
    const colors = {
        info: { bg: '#fff3cd', color: '#856404' },
        success: { bg: '#d4edda', color: '#2f855a' },
        error: { bg: '#f8d7da', color: '#721c24' }
    };
    statusDiv.style.background = colors[type].bg;
    statusDiv.style.color = colors[type].color;
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;

    try {
        if (!passportPhotoFile) { alert('Please take or upload a passport photo'); submitBtn.disabled = false; return; }
        updateStatus('Preparing documents...');
        updateProgress(10);

        const formData = new FormData(e.target);
        const idFrontFile = document.getElementById('id_front').files[0];
        const idBackFile = document.getElementById('id_back').files[0];
        const poaFile = document.getElementById('proof_of_address').files[0];

        updateStatus('Encoding documents...');
        updateProgress(30);

        const [idFrontBase64, idBackBase64, poaBase64, passportBase64] = await Promise.all([
            fileToBase64(idFrontFile),
            fileToBase64(idBackFile),
            fileToBase64(poaFile),
            fileToBase64(passportPhotoFile)
        ]);

        const payload = {
            full_name: formData.get('full_name'),
            email: formData.get('email'),
            id_number: formData.get('id_number'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            data_consent: true,
            consent_timestamp: new Date().toISOString(),
            files: {
                id_front: { data: idFrontBase64, filename: idFrontFile.name, mimeType: idFrontFile.type },
                id_back: { data: idBackBase64, filename: idBackFile.name, mimeType: idBackFile.type },
                proof_of_address: { data: poaBase64, filename: poaFile.name, mimeType: poaFile.type },
                passport_photo: { data: passportBase64, filename: passportPhotoFile.name, mimeType: passportPhotoFile.type }
            }
        };

        updateStatus('Submitting application...');
        updateProgress(70);

        const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Submission failed');
        const result = await response.json();
        updateProgress(100);
        updateStatus('‚úÖ Application Submitted!', 'success');
    } catch (error) {
        updateStatus('‚ùå Error: ' + error.message, 'error');
        submitBtn.disabled = false;
    }
});
</script>
</body>
</html>
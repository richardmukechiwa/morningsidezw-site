<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Onboarding - KYC Verification</title>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.container {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  width: 100%;
  max-width: 520px;
  padding: 30px;
  max-height: 90vh;
  overflow-y: auto;
}
h1 { text-align: center; margin-bottom: 6px; color: #333; }
.subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }
fieldset { border: none; margin-bottom: 24px; padding: 0; }
legend { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 12px; }
.form-group { margin-bottom: 18px; }
label { display: block; font-weight: 600; margin-bottom: 6px; color: #444; font-size: 14px; }
input[type="text"], input[type="tel"], input[type="email"] {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #cbd5e0;
  font-size: 14px;
  transition: border-color 0.3s;
}
input[type="text"]:focus, input[type="tel"]:focus, input[type="email"]:focus {
  outline: none;
  border-color: #667eea;
}
.file-box {
  border: 2px dashed #cbd5e0;
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: #f9fafb;
  position: relative;
  min-height: 60px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.file-box:hover { border-color: #667eea; background: #f3f4f6; }
.file-box.has-file { border-color: #48bb78; background: #f0fff4; border-style: solid; }
.file-box input { 
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
  z-index: 10;
}
.file-box span {
  pointer-events: none;
  position: relative;
  z-index: 1;
}
.file-name { font-size: 12px; margin-top: 6px; color: #2f855a; font-weight: 600; }
button {
  width: 100%;
  padding: 14px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: transform 0.2s, opacity 0.3s;
}
button:hover { transform: translateY(-1px); opacity: 0.95; }
button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
#overallStatus {
  margin-top: 20px;
  font-weight: 600;
  text-align: center;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  display: none;
}
.progress-bar {
  width: 100%;
  height: 4px;
  background: #e2e8f0;
  border-radius: 2px;
  overflow: hidden;
  margin-top: 8px;
  display: none;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
  width: 0%;
}
.consent-box {
  background: #f8f9fa;
  border: 1px solid #cbd5e0;
  border-radius: 8px;
  padding: 16px;
}
.consent-label {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 13px;
  line-height: 1.6;
}
.consent-label input[type="checkbox"] {
  margin-top: 4px;
  margin-right: 12px;
  width: 18px;
  height: 18px;
  cursor: pointer;
  flex-shrink: 0;
}
.consent-text { color: #444; }
.consent-text ul { margin: 10px 0 0 20px; padding: 0; }
.consent-text li { margin: 6px 0; color: #666; }
.camera-section { margin-top: 12px; }
#cameraContainer { margin-top: 12px; display: none; }
.camera-preview {
  width: 100%;
  max-width: 320px;
  border: 2px solid #cbd5e0;
  border-radius: 8px;
  margin: 10px auto;
  display: block;
}
#video { display: block; }
#canvas { display: none; }
#photoPreview {
  margin-top: 12px;
  text-align: center;
}
#photoPreview img {
  max-width: 320px;
  border-radius: 8px;
  border: 2px solid #48bb78;
  display: block;
  margin: 0 auto;
}
button.secondary {
  background: #edf2f7;
  color: #333;
  margin-top: 8px;
}
button.secondary:hover {
  background: #e2e8f0;
}
.divider {
  text-align: center;
  margin: 15px 0;
  color: #999;
  font-size: 13px;
  font-weight: 600;
}
</style>
</head>

<body>
<div class="container">
<h1>üîê Agent Onboarding</h1>
<p class="subtitle">Complete KYC verification to get started</p>

<form id="onboardingForm">
  <fieldset>
    <legend>Personal Information</legend>
    <div class="form-group">
      <label for="full_name">Full Name</label>
      <input id="full_name" type="text" name="full_name" autocomplete="name" required>
    </div>
    <div class="form-group">
      <label for="email">Email Address</label>
      <input id="email" type="email" name="email" autocomplete="email" required>
    </div>
    <div class="form-group">
      <label for="id_number">ID Number</label>
      <input id="id_number" type="text" name="id_number" autocomplete="off" required>
    </div>
    <div class="form-group">
      <label for="phone">Phone</label>
      <input id="phone" type="tel" name="phone" autocomplete="tel" required>
    </div>
    <div class="form-group">
      <label for="address">Address</label>
      <input id="address" type="text" name="address" autocomplete="street-address" required>
    </div>
  </fieldset>

  <fieldset>
    <legend>Required Documents</legend>
    <div class="form-group">
      <label for="id_front">ID Front (Government-issued)</label>
      <div class="file-box" id="idFrontBox">
        <input type="file" id="id_front" accept="image/jpeg,image/jpg,image/png,application/pdf" autocomplete="off" required>
        <span>üìÑ Click to Upload ID Front</span>
        <div class="file-name" id="idFrontName"></div>
      </div>
    </div>
    <div class="form-group">
      <label for="id_back">ID Back</label>
      <div class="file-box" id="idBackBox">
        <input type="file" id="id_back" accept="image/jpeg,image/jpg,image/png,application/pdf" autocomplete="off" required>
        <span>üìÑ Click to Upload ID Back</span>
        <div class="file-name" id="idBackName"></div>
      </div>
    </div>
    <div class="form-group">
      <label for="proof_of_address">Proof of Address</label>
      <div class="file-box" id="poaBox">
        <input type="file" id="proof_of_address" accept="image/jpeg,image/jpg,image/png,application/pdf" autocomplete="off" required>
        <span>üìÑ Click to Upload Proof of Address</span>
        <div class="file-name" id="poaName"></div>
      </div>
    </div>
    <div class="form-group">
      <label for="passport_photo">Passport Photo (Selfie)</label>
      
      <!-- Camera Section -->
      <div class="camera-section">
        <button type="button" class="secondary" id="openCamera">üì∑ Take Photo with Camera</button>
        <div id="cameraContainer">
          <video id="video" class="camera-preview" autoplay playsinline></video>
          <canvas id="canvas" class="camera-preview"></canvas>
          <button type="button" id="capturePhoto">Capture Photo</button>
          <button type="button" class="secondary" id="retakePhoto" style="display:none;">Retake Photo</button>
        </div>
        <div id="photoPreview"></div>
      </div>
      
      <div class="divider">OR</div>
      
      <!-- File Upload -->
      <div class="file-box" id="passportBox">
        <input type="file" id="passport_photo" accept="image/jpeg,image/jpg,image/png" autocomplete="off">
        <span>üì∑ Click to Upload Photo</span>
        <div class="file-name" id="passportName"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Data Protection & Consent</legend>
    <div class="consent-box">
      <label class="consent-label">
        <input type="checkbox" id="data_consent" required>
        <span class="consent-text">
          I consent to the collection, processing, and storage of my personal data for KYC verification purposes.
          <ul>
            <li>Data will be securely stored and encrypted</li>
            <li>Documents analyzed using AI verification</li>
            <li>I can request data deletion at any time</li>
          </ul>
        </span>
      </label>
    </div>
  </fieldset>

  <button type="submit" id="submitBtn">Submit Application</button>

  <div class="progress-bar" id="progressBar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <div id="overallStatus"></div>
</form>
</div>

<script>
// ‚ö†Ô∏è DEBUG MODE - Check browser console for errors
console.log('KYC Form loaded');

// ‚ö†Ô∏è UPDATE THIS WITH YOUR ACTUAL WEBHOOK URL
const WEBHOOK_URL = 'https://api.morningsidezw.com/submit';

let passportPhotoFile = null;
let cameraStream = null;

// Prevent any accidental form reloads
window.addEventListener('beforeunload', (e) => {
  if (cameraStream) {
    console.log('Cleaning up camera stream before unload');
    cameraStream.getTracks().forEach(track => track.stop());
  }
});

console.log('Setting up file boxes...');

const fileBoxes = [
  ['id_front', 'idFrontBox', 'idFrontName'],
  ['id_back', 'idBackBox', 'idBackName'],
  ['proof_of_address', 'poaBox', 'poaName'],
  ['passport_photo', 'passportBox', 'passportName']
];

fileBoxes.forEach(([inputId, boxId, nameId]) => {
  const input = document.getElementById(inputId);
  const box = document.getElementById(boxId);
  const nameEl = document.getElementById(nameId);
  
  if (!input || !box) return;
  
  input.addEventListener('change', (e) => {
    if (e.target.files.length) {
      box.classList.add('has-file');
      const file = e.target.files[0];
      const sizeMB = (file.size / 1024 / 1024).toFixed(1);
      nameEl.textContent = `‚úì ${file.name} (${sizeMB}MB)`;
      
      // If passport photo uploaded via file, use it
      if (inputId === 'passport_photo') {
        passportPhotoFile = file;
        // Stop camera if it's running
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
          document.getElementById('cameraContainer').style.display = 'none';
          document.getElementById('openCamera').style.display = 'inline-block';
        }
      }
    }
  });
});

// Camera functionality
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const openCameraBtn = document.getElementById('openCamera');
const captureBtn = document.getElementById('capturePhoto');
const retakeBtn = document.getElementById('retakePhoto');
const cameraContainer = document.getElementById('cameraContainer');
const photoPreview = document.getElementById('photoPreview');

// CRITICAL FIX: Prevent form submission when camera buttons are clicked
openCameraBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  try {
    // Request camera with mobile-friendly settings
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: 'user' 
      } 
    });
    
    video.srcObject = cameraStream;
    cameraContainer.style.display = 'block';
    openCameraBtn.style.display = 'none';
  } catch (err) {
    console.error('Camera error:', err);
    alert('Camera access denied or not available. Please use file upload instead.');
  }
});

captureBtn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0);
  
  canvas.toBlob((blob) => {
    passportPhotoFile = new File([blob], 'passport_photo.jpg', { type: 'image/jpeg' });
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    photoPreview.innerHTML = '';
    photoPreview.appendChild(img);
    
    video.style.display = 'none';
    canvas.style.display = 'block';
    captureBtn.style.display = 'none';
    retakeBtn.style.display = 'inline-block';
    
    // Stop camera stream
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    
    // Update file name display
    document.getElementById('passportName').textContent = '‚úì Photo captured from camera';
    document.getElementById('passportBox').classList.add('has-file');
  }, 'image/jpeg', 0.9);
});

retakeBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  
  video.style.display = 'block';
  canvas.style.display = 'none';
  captureBtn.style.display = 'inline-block';
  retakeBtn.style.display = 'none';
  photoPreview.innerHTML = '';
  passportPhotoFile = null;
  
  document.getElementById('passportName').textContent = '';
  document.getElementById('passportBox').classList.remove('has-file');
  
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: 'user' 
      } 
    });
    video.srcObject = cameraStream;
  } catch (err) {
    console.error('Camera error:', err);
    alert('Camera access denied. Please use file upload instead.');
    cameraContainer.style.display = 'none';
    openCameraBtn.style.display = 'inline-block';
  }
});

// Handle direct file upload for passport photo
document.getElementById('passport_photo').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    passportPhotoFile = file;
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    photoPreview.innerHTML = '';
    photoPreview.appendChild(img);
    
    // Stop camera if running
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
      cameraContainer.style.display = 'none';
      openCameraBtn.style.display = 'inline-block';
    }
  }
});

function updateProgress(percent) {
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  progressBar.style.display = 'block';
  progressFill.style.width = percent + '%';
}

function updateStatus(message, type = 'info') {
  const statusDiv = document.getElementById('overallStatus');
  statusDiv.style.display = 'block';
  statusDiv.textContent = message;
  
  const colors = {
    info: { bg: '#fff3cd', color: '#856404' },
    success: { bg: '#d4edda', color: '#2f855a' },
    error: { bg: '#f8d7da', color: '#721c24' }
  };
  
  statusDiv.style.background = colors[type].bg;
  statusDiv.style.color = colors[type].color;
}

document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;

  try {
    // Stop camera if still running
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }

    const consentCheckbox = document.getElementById('data_consent');
    if (!consentCheckbox.checked) {
      alert('Please accept the data protection consent');
      submitBtn.disabled = false;
      return;
    }

    updateStatus('Submitting application...');
    updateProgress(30);

    const formData = new FormData(e.target);
    
    // Check if files are selected
    const idFrontFile = document.getElementById('id_front').files[0];
    const idBackFile = document.getElementById('id_back').files[0];
    const poaFile = document.getElementById('proof_of_address').files[0];

    if (!idFrontFile || !idBackFile || !poaFile) {
      alert('Please upload all required documents');
      submitBtn.disabled = false;
      return;
    }

    // Check passport photo (from camera or file upload)
    if (!passportPhotoFile) {
      alert('Please take a photo with camera or upload a passport photo');
      submitBtn.disabled = false;
      return;
    }

    // Generate fake file IDs for testing
    const timestamp = Date.now();
    const idNumber = formData.get('id_number').replace(/[^a-zA-Z0-9]/g, '');
    
    const payload = {
      full_name: formData.get('full_name'),
      email: formData.get('email'),
      id_number: formData.get('id_number'),
      phone: formData.get('phone'),
      address: formData.get('address'),
      data_consent: true,
      consent_timestamp: new Date().toISOString(),
      file_ids: {
        id_front: `TEST_${idNumber}_front_${timestamp}`,
        id_back: `TEST_${idNumber}_back_${timestamp}`,
        poa: `TEST_${idNumber}_poa_${timestamp}`,
        passport_photo: `TEST_${idNumber}_photo_${timestamp}`
      },
      file_metadata: {
        id_front: { name: idFrontFile.name, size: idFrontFile.size, type: idFrontFile.type },
        id_back: { name: idBackFile.name, size: idBackFile.size, type: idBackFile.type },
        poa: { name: poaFile.name, size: poaFile.size, type: poaFile.type },
        passport_photo: { name: passportPhotoFile.name, size: passportPhotoFile.size, type: passportPhotoFile.type }
      }
    };

    updateProgress(70);

    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    updateProgress(90);

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Server error: ${response.status}`);
    }
    
    const result = await response.json();
    updateProgress(100);
    
    // Display success message
    if (result.applicationId) {
      updateStatus(`‚úÖ Application Submitted! ID: ${result.applicationId}`, 'success');
    } else {
      updateStatus('‚úÖ Application submitted successfully!', 'success');
    }

  } catch (error) {
    console.error('Submission error:', error);
    updateStatus('‚ùå Error: ' + error.message, 'error');
    submitBtn.disabled = false;
  }
});
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Agent Onboarding</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <form id="onboardingForm">
        <input type="text" name="full_name" required>
        <input type="text" name="id_number" required>
        <input type="tel" name="phone" required>
        <input type="text" name="address" required>
        
        <!-- File inputs with Drive upload -->
        <input type="file" id="id_front" accept="image/*,.pdf" required>
        <input type="file" id="id_back" accept="image/*,.pdf" required>
        <input type="file" id="proof_of_address" accept="image/*,.pdf" required>
        
        <button type="submit">Submit Application</button>
        <div id="status"></div>
    </form>

    <script>
        let accessToken = null;
        const DRIVE_FOLDER_ID = '1zVW-IehnMzGgIlpCCP2HBKBX_06LyPhb'; // Create a "temp uploads" folder

        // Initialize Google Identity Services
        function initClient() {
            google.accounts.oauth2.initTokenClient({
                client_id: '945659493356-8048qhfic3co7t884mdkj3bhmr8isp3t.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    accessToken = response.access_token;
                    gapi.load('client', loadDriveAPI);
                }
            }).requestAccessToken();
        }

        function loadDriveAPI() {
            gapi.client.load('drive', 'v3');
        }

        // Upload single file to Google Drive
        async function uploadToDrive(file, fileName) {
            const metadata = {
                name: fileName,
                parents: [DRIVE_FOLDER_ID]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: form
            });

            const result = await response.json();
            return result.id; // Return the Google Drive file ID
        }

        // Form submission
        document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Uploading documents...';

            try {
                // Get form data
                const formData = new FormData(e.target);
                const data = {
                    full_name: formData.get('full_name'),
                    id_number: formData.get('id_number'),
                    phone: formData.get('phone'),
                    address: formData.get('address')
                };

                // Upload files to Drive and get file IDs
                statusDiv.textContent = 'Uploading ID Front...';
                const idFrontFile = document.getElementById('id_front').files[0];
                data.id_front_file_id = await uploadToDrive(idFrontFile, `${data.id_number}_id_front_${Date.now()}.${idFrontFile.name.split('.').pop()}`);

                statusDiv.textContent = 'Uploading ID Back...';
                const idBackFile = document.getElementById('id_back').files[0];
                data.id_back_file_id = await uploadToDrive(idBackFile, `${data.id_number}_id_back_${Date.now()}.${idBackFile.name.split('.').pop()}`);

                statusDiv.textContent = 'Uploading Proof of Address...';
                const poaFile = document.getElementById('proof_of_address').files[0];
                data.poa_file_id = await uploadToDrive(poaFile, `${data.id_number}_poa_${Date.now()}.${poaFile.name.split('.').pop()}`);

                // Send lightweight payload to your webhook
                statusDiv.textContent = 'Processing application...';
                const response = await fetch('YOUR_N8N_WEBHOOK_URL', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                statusDiv.textContent = result.status === 'APPROVED' 
                    ? '✅ Application approved!' 
                    : result.status === 'MANUAL_REVIEW'
                    ? '⏳ Application under review'
                    : '❌ Application rejected: ' + result.reason;

            } catch (error) {
                statusDiv.textContent = '❌ Error: ' + error.message;
            }
        });

        // Initialize on page load
        window.onload = initClient;
    </script>
</body>
</html>
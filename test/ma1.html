<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Onboarding - KYC Verification</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 520px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        h1 { text-align: center; margin-bottom: 6px; color: #333; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }
        fieldset { border: none; margin-bottom: 24px; padding: 0; }
        legend { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 12px; border-bottom: 1px solid #eee; width: 100%; padding-bottom: 5px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; color: #444; font-size: 14px; }
        input[type="text"], input[type="tel"], input[type="email"] {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e0; font-size: 14px;
        }
        .file-box {
            border: 2px dashed #cbd5e0; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9fafb;
        }
        .file-box:hover { border-color: #667eea; }
        .file-box.has-file { border-color: #48bb78; background: #f0fff4; border-style: solid; }
        .file-box input { display: none; }
        .file-name { font-size: 12px; margin-top: 6px; color: #2f855a; font-weight: 600; }
        .camera-preview { width: 100%; max-width: 320px; border: 2px solid #cbd5e0; border-radius: 8px; margin: 10px auto; display: block; }
        #photoPreview img { max-width: 100%; border-radius: 8px; border: 2px solid #48bb78; display: block; margin: 10px auto; }
        button {
            width: 100%; padding: 14px; border-radius: 8px; border: none; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #fff; font-weight: 600; cursor: pointer; font-size: 14px;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background: #edf2f7; color: #333; margin-top: 8px; }
        .progress-bar { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: #48bb78; transition: width 0.3s; width: 0%; }
        #overallStatus { margin-top: 20px; font-weight: 600; text-align: center; padding: 12px; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üîê Agent Onboarding</h1>
    <p class="subtitle">Complete KYC verification to get started</p>

    <form id="onboardingForm">
        <fieldset>
            <legend>Personal Information</legend>
            <div class="form-group">
                <label for="full_name">Full Name</label>
                <input id="full_name" name="name" type="text" autocomplete="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <input id="email" name="email" type="email" autocomplete="email" required>
            </div>
            <div class="form-group">
                <label for="id_number">ID Number</label>
                <input id="id_number" name="id_val" type="text" autocomplete="off" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" required>
            </div>
            <div class="form-group">
                <label for="address">Residential Address</label>
                <input id="address" name="address" type="text" autocomplete="street-address" required>
            </div>
        </fieldset>

        <fieldset>
            <legend>Required Documents</legend>
            <div class="form-group">
                <label>ID Front</label>
                <div class="file-box">
                    <input type="file" id="id_front" accept="image/*,.pdf" capture="environment" required>
                    <span>üìÑ Take Photo or Upload Front</span><div class="file-name"></div>
                </div>
            </div>
            <div class="form-group">
                <label>ID Back</label>
                <div class="file-box">
                    <input type="file" id="id_back" accept="image/*,.pdf" capture="environment" required>
                    <span>üìÑ Take Photo or Upload Back</span><div class="file-name"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Proof of Address</label>
                <div class="file-box">
                    <input type="file" id="proof_of_address" accept="image/*,.pdf" capture="environment" required>
                    <span>üìÑ Take Photo or Upload Proof</span><div class="file-name"></div>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Identity Verification</legend>
            <button type="button" class="secondary" id="openCamera">üì∑ Live Selfie Camera</button>
            <div id="cameraContainer" style="display:none; margin-top:10px;">
                <video id="video" class="camera-preview" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
                <button type="button" id="capturePhoto">Capture Selfie</button>
                <button type="button" class="secondary" id="retakePhoto" style="display:none;">Retake</button>
            </div>
            <div style="text-align:center; margin:15px 0; color:#999; font-weight:600; font-size:12px;">OR</div>
            <div class="file-box">
                <input type="file" id="passport_photo" accept="image/*">
                <span>üñºÔ∏è Upload Gallery Photo</span><div class="file-name"></div>
            </div>
            <div id="photoPreview"></div>
        </fieldset>

        <button type="submit" id="submitBtn">Submit Securely</button>
        <div class="progress-bar" id="progressBar" style="display:none;"><div class="progress-fill" id="progressFill"></div></div>
        <div id="overallStatus"></div>
    </form>
</div>

<script>
const WEBHOOK_URL = 'https://api.morningsidezw.com/submit';
let passportPhotoFile = null;
let stream = null;

async function shrinkImage(file) {
    if (file.type === "application/pdf") return file;
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width; let height = img.height;
                if (width > 1200) { height *= 1200 / width; width = 1200; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => resolve(new File([blob], file.name, { type: 'image/jpeg' })), 'image/jpeg', 0.7);
            };
        };
    });
}

document.querySelectorAll('.file-box').forEach(box => {
    const input = box.querySelector('input');
    const nameEl = box.querySelector('.file-name');
    box.addEventListener('click', (e) => { if (e.target !== input) input.click(); });

    input.addEventListener('change', async (e) => {
        if (e.target.files.length) {
            nameEl.textContent = 'Processing...';
            const compressed = await shrinkImage(e.target.files[0]);
            input.compressedFile = compressed;
            box.classList.add('has-file');
            nameEl.textContent = '‚úì ' + compressed.name;
            if(input.id === 'passport_photo') { 
                passportPhotoFile = compressed;
                renderPreview(compressed);
            }
        }
    });
});

function renderPreview(file) {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    const preview = document.getElementById('photoPreview');
    preview.innerHTML = ''; preview.appendChild(img);
}

document.getElementById('openCamera').onclick = async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        document.getElementById('video').srcObject = stream;
        document.getElementById('cameraContainer').style.display = 'block';
        document.getElementById('openCamera').style.display = 'none';
    } catch (err) { alert('Camera access denied'); }
};

document.getElementById('capturePhoto').onclick = () => {
    const v = document.getElementById('video');
    const c = document.getElementById('canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    c.toBlob(async (blob) => {
        passportPhotoFile = await shrinkImage(new File([blob], 'selfie.jpg', {type:'image/jpeg'}));
        renderPreview(passportPhotoFile);
        v.style.display = 'none';
        document.getElementById('capturePhoto').style.display = 'none';
        document.getElementById('retakePhoto').style.display = 'inline-block';
        if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    }, 'image/jpeg', 0.8);
};

document.getElementById('retakePhoto').onclick = () => {
    document.getElementById('video').style.display = 'block';
    document.getElementById('capturePhoto').style.display = 'inline-block';
    document.getElementById('retakePhoto').style.display = 'none';
    document.getElementById('openCamera').click();
};

// IMPROVED SUBMISSION LOGIC
document.getElementById('onboardingForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const status = document.getElementById('overallStatus');
    const fill = document.getElementById('progressFill');

    if(!passportPhotoFile) { alert('Selfie or Passport Photo is required'); return; }
    
    btn.disabled = true;
    status.style.display = 'block';
    status.textContent = 'Uploading files...';
    document.getElementById('progressBar').style.display = 'block';
    fill.style.width = '40%';

    try {
        const formData = new FormData();
        
        // Text Data
        formData.append('full_name', document.getElementById('full_name').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('id_number', document.getElementById('id_number').value);
        formData.append('phone', document.getElementById('phone').value);
        formData.append('address', document.getElementById('address').value);
        formData.append('data_consent', 'true');

        // File Data (sent as real files, not base64 strings)
        formData.append('id_front', document.getElementById('id_front').compressedFile);
        formData.append('id_back', document.getElementById('id_back').compressedFile);
        formData.append('proof_of_address', document.getElementById('proof_of_address').compressedFile);
        formData.append('passport_photo', passportPhotoFile);

        const res = await fetch(WEBHOOK_URL, {
            method: 'POST',
            body: formData // No manual headers - Browser sets them!
        });

        if(!res.ok) throw new Error(`Server responded with ${res.status}`);

        fill.style.width = '100%';
        status.textContent = '‚úÖ Application Submitted Successfully!';
        status.style.background = '#d4edda'; status.style.color = '#2f855a';
        
    } catch (err) {
        status.textContent = '‚ùå Submission Failed: ' + err.message;
        status.style.background = '#f8d7da'; status.style.color = '#721c24';
        btn.disabled = false;
    }
};
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Onboarding - KYC Verification</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.container {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  width: 100%;
  max-width: 520px;
  padding: 30px;
  max-height: 90vh;
  overflow-y: auto;
}
h1 { 
  text-align: center; 
  margin-bottom: 6px;
  color: #333;
}
.subtitle { 
  text-align: center; 
  color: #666; 
  margin-bottom: 20px;
  font-size: 14px;
}
fieldset {
  border: none;
  margin-bottom: 24px;
  padding: 0;
}
legend {
  font-size: 18px;
  font-weight: 700;
  color: #333;
  margin-bottom: 12px;
}
.form-group { margin-bottom: 18px; }
label { 
  display: block; 
  font-weight: 600; 
  margin-bottom: 6px;
  color: #444;
  font-size: 14px;
}
input[type="text"], 
input[type="tel"],
input[type="email"] {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #cbd5e0;
  font-size: 14px;
  transition: border-color 0.3s;
}
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="email"]:focus {
  outline: none;
  border-color: #667eea;
}
.file-box {
  border: 2px dashed #cbd5e0;
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: #f9fafb;
}
.file-box:hover {
  border-color: #667eea;
  background: #f3f4f6;
}
.file-box.has-file {
  border-color: #48bb78;
  background: #f0fff4;
  border-style: solid;
}
.file-box input { display: none; }
.file-name { 
  font-size: 12px; 
  margin-top: 6px;
  color: #2f855a;
  font-weight: 600;
}
.info-text {
  color: #666;
  font-size: 13px;
  margin: 10px 0;
  line-height: 1.5;
}
.camera-section {
  margin-top: 12px;
}
#cameraContainer {
  margin-top: 12px;
}
.camera-preview {
  width: 100%;
  max-width: 320px;
  border: 2px solid #cbd5e0;
  border-radius: 8px;
  margin: 10px auto;
  display: block;
}
#video { display: block; }
#canvas { display: none; }
#photoPreview {
  margin-top: 12px;
  text-align: center;
}
#photoPreview img {
  max-width: 320px;
  border-radius: 8px;
  border: 2px solid #48bb78;
  display: block;
  margin: 0 auto;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: transform 0.2s, opacity 0.3s;
}
button:hover {
  transform: translateY(-1px);
  opacity: 0.95;
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
button.secondary {
  background: #edf2f7;
  color: #333;
  margin-top: 8px;
}
button.secondary:hover {
  background: #e2e8f0;
}
.status {
  font-size: 13px;
  margin-top: 6px;
  padding: 8px;
  border-radius: 6px;
  text-align: center;
}
.status.ok { 
  background: #d4edda;
  color: #2f855a; 
}
.status.error {
  background: #f8d7da;
  color: #721c24;
}
.status.uploading {
  background: #fff3cd;
  color: #856404;
}
#overallStatus {
  margin-top: 20px;
  font-weight: 600;
  text-align: center;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
}
.divider {
  text-align: center;
  margin: 15px 0;
  color: #999;
  font-size: 13px;
  font-weight: 600;
}
.progress-bar {
  width: 100%;
  height: 4px;
  background: #e2e8f0;
  border-radius: 2px;
  overflow: hidden;
  margin-top: 8px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
  width: 0%;
}
</style>
</head>

<body>
<div class="container">
<h1>üîê Agent Onboarding</h1>
<p class="subtitle">Complete KYC verification to get started</p>

<form id="onboardingForm">

<!-- Personal Information -->
<fieldset>
<legend>Personal Information</legend>

<div class="form-group">
<label>Full Name</label>
<input type="text" name="full_name" required>
</div>

<div class="form-group">
<label>Email Address</label>
<input type="email" name="email" required>
</div>

<div class="form-group">
<label>ID Number</label>
<input type="text" name="id_number" required>
</div>

<div class="form-group">
<label>Phone</label>
<input type="tel" name="phone" required>
</div>

<div class="form-group">
<label>Address</label>
<input type="text" name="address" required>
</div>
</fieldset>

<!-- Required Documents -->
<fieldset>
<legend>Required Documents</legend>

<div class="form-group">
<label>ID Front (Government-issued)</label>
<div class="file-box" id="idFrontBox">
<input type="file" id="id_front" accept="image/*,.pdf" required>
<span>üìÑ Upload ID Front</span>
<div class="file-name" id="idFrontName"></div>
</div>
<div class="status" id="status_id_front"></div>
</div>

<div class="form-group">
<label>ID Back</label>
<div class="file-box" id="idBackBox">
<input type="file" id="id_back" accept="image/*,.pdf" required>
<span>üìÑ Upload ID Back</span>
<div class="file-name" id="idBackName"></div>
</div>
<div class="status" id="status_id_back"></div>
</div>

<div class="form-group">
<label>Proof of Address (Utility bill/Bank statement)</label>
<div class="file-box" id="poaBox">
<input type="file" id="proof_of_address" accept="image/*,.pdf" required>
<span>üìÑ Upload Proof of Address</span>
<div class="file-name" id="poaName"></div>
</div>
<div class="status" id="status_poa"></div>
</div>
</fieldset>

<!-- Passport Photo Section -->
<fieldset>
<legend>Identity Verification</legend>
<p class="info-text">
Take a clear selfie or upload a recent passport-style photo. This will be compared with your ID photo.
</p>

<div class="camera-section">
<button type="button" class="secondary" id="openCamera">üì∑ Take Photo with Camera</button>

<div id="cameraContainer" style="display:none;">
<video id="video" class="camera-preview" autoplay></video>
<canvas id="canvas" class="camera-preview"></canvas>
<button type="button" id="capturePhoto">Capture Photo</button>
<button type="button" class="secondary" id="retakePhoto" style="display:none;">Retake</button>
</div>
</div>

<div class="divider">OR</div>

<div class="form-group">
<div class="file-box" id="passportBox">
<input type="file" id="passport_photo" accept="image/*">
<span>üì∑ Upload Passport Photo</span>
<div class="file-name" id="passportName"></div>
</div>
<div class="status" id="status_passport"></div>
</div>

<div id="photoPreview"></div>
</fieldset>

<button type="submit" id="submitBtn">Submit Application</button>
<div class="progress-bar" id="progressBar" style="display:none;">
<div class="progress-fill" id="progressFill"></div>
</div>
<div id="overallStatus"></div>

</form>
</div>

<script>
// ‚ö†Ô∏è CRITICAL CONFIGURATION - UPDATE THESE VALUES
const CONFIG = {
  // Your n8n webhook URL (from the optimized workflow)
  WEBHOOK_URL: 'https://api.morningsidezw.com/submit',
  
  // Google Drive folder ID where files will be uploaded (must be public/shared)
  DRIVE_FOLDER_ID: '1zVW-IehnMzGgIlpCCP2HBKBX_06LyPhb', // UPDATE THIS
  
  // Google OAuth Client ID (get from Google Cloud Console)
  GOOGLE_CLIENT_ID: '945659493356-8048qhfic3co7t884mdkj3bhmr8isp3t.apps.googleusercontent.com' // UPDATE THIS
};

let accessToken = null;
let passportPhotoFile = null;
let stream = null;

// Initialize Google OAuth
function initClient() {
  google.accounts.oauth2.initTokenClient({
    client_id: CONFIG.GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.file',
    callback: (response) => {
      accessToken = response.access_token;
      gapi.load('client', () => gapi.client.load('drive', 'v3'));
    }
  }).requestAccessToken();
}

// File upload boxes
const fileBoxes = [
  ['id_front','idFrontBox','idFrontName'],
  ['id_back','idBackBox','idBackName'],
  ['proof_of_address','poaBox','poaName'],
  ['passport_photo','passportBox','passportName']
];

fileBoxes.forEach(([inputId, boxId, nameId]) => {
  const input = document.getElementById(inputId);
  const box = document.getElementById(boxId);
  const nameEl = document.getElementById(nameId);
  
  if (!input || !box) return;
  
  box.addEventListener('click', () => input.click());
  
  input.addEventListener('change', (e) => {
    if (e.target.files.length) {
      box.classList.add('has-file');
      nameEl.textContent = '‚úì ' + e.target.files[0].name;
    }
  });
});

// Camera functionality
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const openCameraBtn = document.getElementById('openCamera');
const captureBtn = document.getElementById('capturePhoto');
const retakeBtn = document.getElementById('retakePhoto');
const cameraContainer = document.getElementById('cameraContainer');
const photoPreview = document.getElementById('photoPreview');

openCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: 640, height: 480, facingMode: 'user' } 
    });
    video.srcObject = stream;
    cameraContainer.style.display = 'block';
    openCameraBtn.style.display = 'none';
  } catch (err) {
    alert('Camera access denied: ' + err.message);
  }
});

captureBtn.addEventListener('click', () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0);
  
  canvas.toBlob((blob) => {
    passportPhotoFile = new File([blob], 'passport_photo.jpg', { type: 'image/jpeg' });
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    photoPreview.innerHTML = '';
    photoPreview.appendChild(img);
    
    video.style.display = 'none';
    canvas.style.display = 'block';
    captureBtn.style.display = 'none';
    retakeBtn.style.display = 'inline-block';
    
    document.getElementById('status_passport').textContent = '‚úì Photo captured';
    document.getElementById('status_passport').className = 'status ok';
    
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }, 'image/jpeg', 0.9);
});

retakeBtn.addEventListener('click', async () => {
  video.style.display = 'block';
  canvas.style.display = 'none';
  captureBtn.style.display = 'inline-block';
  retakeBtn.style.display = 'none';
  photoPreview.innerHTML = '';
  passportPhotoFile = null;
  document.getElementById('status_passport').textContent = '';
  
  try {
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: 640, height: 480, facingMode: 'user' } 
    });
    video.srcObject = stream;
  } catch (err) {
    alert('Camera access denied: ' + err.message);
  }
});

document.getElementById('passport_photo').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    passportPhotoFile = file;
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    photoPreview.innerHTML = '';
    photoPreview.appendChild(img);
    
    document.getElementById('status_passport').textContent = '‚úì Photo selected';
    document.getElementById('status_passport').className = 'status ok';
    
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      cameraContainer.style.display = 'none';
      openCameraBtn.style.display = 'inline-block';
    }
  }
});

// Progress and status functions
function updateProgress(percent) {
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  progressBar.style.display = 'block';
  progressFill.style.width = percent + '%';
}

function updateStatus(message, type = 'info') {
  const statusDiv = document.getElementById('overallStatus');
  statusDiv.textContent = message;
  
  const colors = {
    info: { bg: '#fff3cd', color: '#856404' },
    success: { bg: '#d4edda', color: '#2f855a' },
    error: { bg: '#f8d7da', color: '#721c24' }
  };
  
  statusDiv.style.background = colors[type].bg;
  statusDiv.style.color = colors[type].color;
}

// Upload file to Google Drive
async function uploadToDrive(file, fileName, statusElementId) {
  const statusEl = document.getElementById(statusElementId);
  statusEl.textContent = 'Uploading to Drive...';
  statusEl.className = 'status uploading';
  
  const metadata = {
    name: fileName,
    parents: [CONFIG.DRIVE_FOLDER_ID]
  };

  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', file);

  try {
    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}` },
      body: form
    });

    if (!response.ok) throw new Error('Upload failed');

    const result = await response.json();
    
    // Make file publicly accessible for OpenAI
    await fetch(`https://www.googleapis.com/drive/v3/files/${result.id}/permissions`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        role: 'reader',
        type: 'anyone'
      })
    });
    
    statusEl.textContent = '‚úì Uploaded';
    statusEl.className = 'status ok';
    
    return result.id; // Return Drive file ID
  } catch (error) {
    statusEl.textContent = '‚úó Upload failed';
    statusEl.className = 'status error';
    throw error;
  }
}

// Form submission
document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;

  try {
    if (!passportPhotoFile) {
      alert('Please take or upload a passport photo');
      submitBtn.disabled = false;
      return;
    }

    const formData = new FormData(e.target);
    const data = {
      full_name: formData.get('full_name'),
      email: formData.get('email'),
      id_number: formData.get('id_number'),
      phone: formData.get('phone'),
      address: formData.get('address')
    };

    updateStatus('Uploading documents to Google Drive...');
    updateProgress(10);

    // Upload files and get Drive file IDs
    const idFrontFile = document.getElementById('id_front').files[0];
    data.id_front_file_id = await uploadToDrive(
      idFrontFile, 
      `${data.id_number}_id_front_${Date.now()}.${idFrontFile.name.split('.').pop()}`,
      'status_id_front'
    );
    updateProgress(30);

    const idBackFile = document.getElementById('id_back').files[0];
    data.id_back_file_id = await uploadToDrive(
      idBackFile, 
      `${data.id_number}_id_back_${Date.now()}.${idBackFile.name.split('.').pop()}`,
      'status_id_back'
    );
    updateProgress(50);

    const poaFile = document.getElementById('proof_of_address').files[0];
    data.poa_file_id = await uploadToDrive(
      poaFile, 
      `${data.id_number}_poa_${Date.now()}.${poaFile.name.split('.').pop()}`,
      'status_poa'
    );
    updateProgress(70);

    data.passport_photo_file_id = await uploadToDrive(
      passportPhotoFile,
      `${data.id_number}_passport_${Date.now()}.jpg`,
      'status_passport'
    );
    updateProgress(85);

    // Send to n8n webhook with file IDs (not URLs)
    updateStatus('Processing your application...');
    const response = await fetch(CONFIG.WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!response.ok) throw new Error('Submission failed');
    
    const result = await response.json();
    updateProgress(100);
    
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    if (result.status === 'APPROVED') {
      updateStatus('‚úÖ Application Approved! Welcome aboard!', 'success');
    } else if (result.status === 'MANUAL_REVIEW') {
      updateStatus('‚è≥ Application Under Review - We will contact you within 24-48 hours', 'info');
    } else {
      updateStatus('‚ùå Application Rejected: ' + (result.reason || 'Please contact support'), 'error');
      submitBtn.disabled = false;
    }

  } catch (error) {
    console.error('Submission error:', error);
    updateStatus('‚ùå Error: ' + error.message, 'error');
    submitBtn.disabled = false;
  }
});

// Initialize Google OAuth on page load
window.onload = initClient;
</script>
</body>
</html>
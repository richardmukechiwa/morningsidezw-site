<!DOCTYPE html>
<html lang="en">
<head>
    <title>Agent Onboarding - KYC Verification</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>

       
        .camera-preview {
            width: 320px;
            height: 240px;
            border: 2px solid #ccc;
            margin: 10px 0;
        }
        #video { display: block; }
        #canvas { display: none; }
        .file-status { 
            margin: 5px 0; 
            padding: 5px; 
            background: #f0f0f0; 
            border-radius: 3px;
        }
        .uploaded { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <form id="onboardingForm">
        <h2>Agent Onboarding Application</h2>
        
        <!-- Personal Information -->
        <fieldset>
            <legend>Personal Information</legend>
            <label>Full Name: <input type="text" name="full_name" required></label><br>
            <label>ID Number: <input type="text" name="id_number" required></label><br>
            <label>Phone: <input type="tel" name="phone" required></label><br>
            <label>Address: <input type="text" name="address" required></label><br>
        </fieldset>

        <!-- Document Uploads -->
        <fieldset>
            <legend>Required Documents</legend>
            
            <label>ID Front (Government-issued ID):
                <input type="file" id="id_front" accept="image/*,.pdf" required>
                <div id="status_id_front" class="file-status"></div>
            </label><br>

            <label>ID Back:
                <input type="file" id="id_back" accept="image/*,.pdf" required>
                <div id="status_id_back" class="file-status"></div>
            </label><br>

            <label>Proof of Address (Utility bill/Bank statement):
                <input type="file" id="proof_of_address" accept="image/*,.pdf" required>
                <div id="status_poa" class="file-status"></div>
            </label><br>
        </fieldset>

        <!-- NEW: Passport Photo / Selfie Section -->
        <fieldset>
            <legend>Identity Verification (Passport Photo)</legend>
            <p style="color: #666; font-size: 0.9em;">
                Take a clear selfie or upload a recent passport-style photo. 
                This will be compared with your ID photo.
            </p>
            
            <!-- Option 1: Take Photo with Camera -->
            <div id="camera-section">
                <button type="button" id="openCamera">üì∑ Take Photo with Camera</button>
                <div id="camera-container" style="display: none;">
                    <video id="video" class="camera-preview" autoplay></video>
                    <canvas id="canvas" class="camera-preview"></canvas>
                    <button type="button" id="capturePhoto">Capture Photo</button>
                    <button type="button" id="retakePhoto" style="display: none;">Retake</button>
                </div>
            </div>

            <!-- Option 2: Upload Existing Photo -->
            <p style="margin: 10px 0;">OR</p>
            <label>Upload Passport Photo:
                <input type="file" id="passport_photo" accept="image/*">
                <div id="status_passport" class="file-status"></div>
            </label>

            <!-- Preview -->
            <div id="photoPreview" style="margin-top: 10px;"></div>
        </fieldset>

        <button type="submit" id="submitBtn">Submit Application</button>
        <div id="overallStatus" style="margin-top: 20px; font-weight: bold;"></div>
    </form>

    <script>
        let accessToken = null;
        const DRIVE_FOLDER_ID = '1zVW-IehnMzGgIlpCCP2HBKBX_06LyPhb';
        let passportPhotoFile = null; // Store captured/uploaded photo
        let stream = null; // Camera stream

        // Initialize Google Identity Services
        function initClient() {
            google.accounts.oauth2.initTokenClient({
                client_id: '945659493356-8048qhfic3co7t884mdkj3bhmr8isp3t.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    accessToken = response.access_token;
                    gapi.load('client', () => gapi.client.load('drive', 'v3'));
                }
            }).requestAccessToken();
        }

        // Camera functionality
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const openCameraBtn = document.getElementById('openCamera');
        const captureBtn = document.getElementById('capturePhoto');
        const retakeBtn = document.getElementById('retakePhoto');
        const cameraContainer = document.getElementById('camera-container');
        const photoPreview = document.getElementById('photoPreview');

        openCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user' // Use front camera on mobile
                    } 
                });
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                openCameraBtn.style.display = 'none';
            } catch (err) {
                alert('Camera access denied: ' + err.message);
            }
        });

        captureBtn.addEventListener('click', () => {
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0);
            
            // Convert canvas to blob
            canvas.toBlob((blob) => {
                passportPhotoFile = new File([blob], 'passport_photo.jpg', { type: 'image/jpeg' });
                
                // Show preview
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                img.style.maxWidth = '320px';
                img.style.border = '2px solid green';
                photoPreview.innerHTML = '';
                photoPreview.appendChild(img);
                
                // Update UI
                video.style.display = 'none';
                canvas.style.display = 'block';
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';
                
                document.getElementById('status_passport').textContent = '‚úì Photo captured';
                document.getElementById('status_passport').className = 'file-status uploaded';
            }, 'image/jpeg', 0.9);
        });

        retakeBtn.addEventListener('click', () => {
            video.style.display = 'block';
            canvas.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            retakeBtn.style.display = 'none';
            photoPreview.innerHTML = '';
            passportPhotoFile = null;
            document.getElementById('status_passport').textContent = '';
        });

        // Handle file upload option
        document.getElementById('passport_photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                passportPhotoFile = file;
                
                // Show preview
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '320px';
                img.style.border = '2px solid green';
                photoPreview.innerHTML = '';
                photoPreview.appendChild(img);
                
                document.getElementById('status_passport').textContent = '‚úì Photo selected';
                document.getElementById('status_passport').className = 'file-status uploaded';
                
                // Stop camera if running
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    cameraContainer.style.display = 'none';
                    openCameraBtn.style.display = 'inline-block';
                }
            }
        });

        // Upload single file to Google Drive
        async function uploadToDrive(file, fileName, statusElementId) {
            const statusEl = document.getElementById(statusElementId);
            statusEl.textContent = 'Uploading...';
            
            const metadata = {
                name: fileName,
                parents: [DRIVE_FOLDER_ID]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}` },
                body: form
            });

            const result = await response.json();
            statusEl.textContent = '‚úì Uploaded';
            statusEl.className = 'file-status uploaded';
            return result.id;
        }

        // Form submission
        document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const statusDiv = document.getElementById('overallStatus');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;

            try {
                // Validate passport photo
                if (!passportPhotoFile) {
                    alert('Please take or upload a passport photo');
                    submitBtn.disabled = false;
                    return;
                }

                // Get form data
                const formData = new FormData(e.target);
                const data = {
                    full_name: formData.get('full_name'),
                    id_number: formData.get('id_number'),
                    phone: formData.get('phone'),
                    address: formData.get('address')
                };

                statusDiv.textContent = 'Uploading documents to secure storage...';

                // Upload all files to Drive
                const idFrontFile = document.getElementById('id_front').files[0];
                data.id_front_file_id = await uploadToDrive(
                    idFrontFile, 
                    `${data.id_number}_id_front_${Date.now()}.${idFrontFile.name.split('.').pop()}`,
                    'status_id_front'
                );

                const idBackFile = document.getElementById('id_back').files[0];
                data.id_back_file_id = await uploadToDrive(
                    idBackFile, 
                    `${data.id_number}_id_back_${Date.now()}.${idBackFile.name.split('.').pop()}`,
                    'status_id_back'
                );

                const poaFile = document.getElementById('proof_of_address').files[0];
                data.poa_file_id = await uploadToDrive(
                    poaFile, 
                    `${data.id_number}_poa_${Date.now()}.${poaFile.name.split('.').pop()}`,
                    'status_poa'
                );

                // Upload passport photo
                data.passport_photo_file_id = await uploadToDrive(
                    passportPhotoFile,
                    `${data.id_number}_passport_${Date.now()}.jpg`,
                    'status_passport'
                );

                // Send to webhook
                statusDiv.textContent = 'Processing application...';
                const response = await fetch('YOUR_N8N_WEBHOOK_URL', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                // Stop camera if running
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                statusDiv.textContent = result.status === 'APPROVED' 
                    ? '‚úÖ Application Approved!' 
                    : result.status === 'MANUAL_REVIEW'
                    ? '‚è≥ Application Under Review - We will contact you within 24 hours'
                    : '‚ùå Application Rejected: ' + result.reason;

            } catch (error) {
                statusDiv.textContent = '‚ùå Error: ' + error.message;
                submitBtn.disabled = false;
            }
        });

        // Initialize on page load
        window.onload = initClient;
    </script>
</body>
</html>
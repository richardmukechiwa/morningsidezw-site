<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agent Onboarding</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, button { margin-top: 5px; }
    #result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Agent Onboarding Form</h1>
  <form id="onboardingForm">
    <label>Full Name: <input type="text" id="fullName" required></label>
    <label>ID Number: <input type="text" id="idNumber" required></label>
    <label>Email: <input type="email" id="email" required></label>
    <label>Phone: <input type="text" id="phone" required></label>
    <label>Address: <input type="text" id="address" required></label>

    <label>ID Front: <input type="file" id="idFront" accept="image/*" required></label>
    <label>ID Back: <input type="file" id="idBack" accept="image/*" required></label>
    <label>Proof of Address: <input type="file" id="proofAddress" accept="image/*" required></label>

    <button type="submit">Submit</button>
  </form>

  <div id="result">
    <h3 id="resultTitle"></h3>
    <div id="resultDetails"></div>
  </div>

  <script>
    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]); // Base64 only
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const webhookUrl = 'https://YOUR_N8N_DOMAIN/webhook/onboard-agent-mvs';

      // Convert files to base64
      const files = {
        id_front: await fileToBase64(document.getElementById('idFront').files[0]),
        id_back: await fileToBase64(document.getElementById('idBack').files[0]),
        proof_of_address: await fileToBase64(document.getElementById('proofAddress').files[0])
      };

      // Flatten agent data as required by workflow
      const body = {
        name: document.getElementById('fullName').value,
        idNumber: document.getElementById('idNumber').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        address: document.getElementById('address').value,
        binary: files
      };

      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();
        const titleDiv = document.getElementById('resultTitle');
        const detailsDiv = document.getElementById('resultDetails');

        if (result.success) {
          if (result.processingStatus === 'APPROVED') {
            titleDiv.textContent = '✅ Application Approved';
          } else if (result.processingStatus === 'MANUAL_REVIEW') {
            titleDiv.textContent = '⚠️ Application Requires Manual Review';
          } else {
            titleDiv.textContent = '❌ Application Status Unknown';
          }

          detailsDiv.innerHTML = `<p><strong>Notes:</strong> ${result.reviewNotes || 'None'}</p>`;
        } else {
          titleDiv.textContent = '❌ Submission Failed';
          detailsDiv.innerHTML = `<p>${result.reason || result.error || 'Unknown error'}</p>`;
        }
      } catch (err) {
        document.getElementById('resultTitle').textContent = '❌ Submission Error';
        document.getElementById('resultDetails').textContent = err.message;
      }
    });
  </script>
</body>
</html>
